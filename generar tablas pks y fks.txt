CREATE TABLE IF NOT EXISTS local_sell(
  id INTEGER,
  address VARCHAR(50),
  date_time TIMESTAMP WITHOUT TIME ZONE,
  total_price MONEY,
  payment_method VARCHAR(20)
);

CREATE TABLE IF NOT EXISTS company_local_buy (
  ruc NUMERIC(11,0),
  id SERIAL,
  invoice_number NUMERIC(11,0)
);

CREATE TABLE IF NOT EXISTS company_delivery_sell (
  ruc NUMERIC(11,0),
  id SERIAL,
  invoice_number NUMERIC(11,0)
);

CREATE TABLE IF NOT EXISTS companies (
  ruc NUMERIC(11, 0),
  social_reason VARCHAR(50),
  address VARCHAR(50),
  email VARCHAR(50),
  phone_number VARCHAR(12),
  name VARCHAR(50)
);

CREATE TABLE IF NOT EXISTS provider_company (
  ruc NUMERIC(11, 0),
  provides_count INTEGER
);

CREATE TABLE IF NOT EXISTS client_company (
  ruc NUMERIC(11, 0)
);

CREATE TABLE IF NOT EXISTS provisions (
  id SERIAL,
  address VARCHAR(50),
  ruc NUMERIC(11, 0),
  date_time TIMESTAMP WITHOUT TIME ZONE,
  total_price MONEY
);
CREATE TABLE IF NOT EXISTS worker (
  id SERIAL NOT NULL,
  person_dni NUMERIC(8,0) NOT NULL,
  phone_number VARCHAR(12) NOT NULL,
  salary INT NOT NULL,
  address VARCHAR(50) NOT NULL
);

CREATE TABLE IF NOT EXISTS delivery_man(
  worker_id SERIAL NOT NULL,
  vehicle_plate VARCHAR(6) NOT NULL
);

CREATE TABLE IF NOT EXISTS shop_worker(
  worker_id SERIAL NOT NULL,
  shop_address VARCHAR(50) NOT NULL,
  position VARCHAR(15) NOT NULL
);

CREATE TABLE IF NOT EXISTS manager(
  worker_id SERIAL NOT NULL,
  position VARCHAR(15) NOT NULL
);

CREATE TABLE IF NOT EXISTS in_charge(
  shop_address VARCHAR(50) NOT NULL,
  manager_id SERIAL NOT NULL
);

--ENTIDAD DEBIL
CREATE TABLE IF NOT EXISTS shift(
  worker_id SERIAL NOT NULL,
  week_day VARCHAR(10) NOT NULL,
  arrival_time TIMESTAMP NOT NULL,
  departure_time TIMESTAMP NOT NULL
);
-- 

CREATE TABLE IF NOT EXISTS vehicle(
  plate VARCHAR(6) NOT NULL,
  shop_address VARCHAR(50) NOT NULL,
  number_of_deliveries INT NOT NULL
);

CREATE TABLE IF NOT EXISTS shop(
  address VARCHAR(50) NOT NULL,
  phone_number VARCHAR(12) NOT NULL,
  shop_size VARCHAR(10) NOT NULL 
);
CREATE TABLE IF NOT EXISTS customer_detail(
    dni NUMERIC(8,0),
    id SERIAL
);

CREATE TABLE IF NOT EXISTS employee_detail(
    dni NUMERIC(8,0),
    id SERIAL
);


CREATE TABLE IF NOT EXISTS client(
    id SERIAL
);


CREATE TABLE IF NOT EXISTS client_store(
    id SERIAL,
    n_visits INTEGER
);


CREATE TABLE IF NOT EXISTS purchase_local(
    v_id SERIAL,
    c_id SERIAL
);

CREATE TABLE IF NOT EXISTS compra_delivery(
    v_id SERIAL,
    c_id SERIAL
);

CREATE TABLE IF NOT EXISTS client_delivery(
    id SERIAL,
    direction VARCHAR (50),
    n_telephone VARCHAR (12)
);

CREATE TABLE IF NOT EXISTS products (
  code SERIAL NOT NULL,
  price MONEY NOT NULL,
  category VARCHAR(12) NOT NULL,
  brand VARCHAR(12) NOT NULL,
  description VARCHAR(50) NOT NULL
);
CREATE TABLE IF NOT EXISTS promotions (
  id SERIAL NOT NULL,
  validity BOOLEAN NOT NULL,
  value MONEY NOT NULL
);
CREATE TABLE IF NOT EXISTS products_list (
  date DATE NOT NULL,
	validity BOOLEAN NOT NULL
);
CREATE TABLE IF NOT EXISTS isin (
  product_code SERIAL NOT NULL UNIQUE,
  product_list_date DATE NOT NULL
	);
CREATE TABLE IF NOT EXISTS products_sell (
id SERIAL NOT NULL,
local_direction VARCHAR(50) NOT NULL ,
  product_code SERIAL NOT NULL,
  expiration_date DATE NOT NULL,
	exhibition_type VARCHAR(12) NOT NULL ,
	stock NUMERIC(4,0) NOT NULL
);
CREATE TABLE IF NOT EXISTS delivery_sell (
id SERIAL NOT NULL,
local_direction VARCHAR(50) NOT NULL ,
  date DATE NOT NULL,
  total MONEY NOT NULL,
	payment_method VARCHAR(50)
);

CREATE TABLE IF NOT EXISTS has_promotion (
  promotion_id SERIAL NOT NULL,
	product_code SERIAL NOT NULL
);
CREATE TABLE IF NOT EXISTS person_detail (
  dni NUMERIC(8,0) NOT NULL,
	name VARCHAR(20) NOT NULL
);


CREATE TABLE IF NOT EXISTS sell_unit_local (
  subtotal MONEY NOT NULL,
	amount INTEGER NOT NULL,
	product_id SERIAL NOT NULL UNIQUE,
	sell_id SERIAL NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS sell_unit_delivery (
  subtotal MONEY NOT NULL,
	amount INTEGER NOT NULL,
	product_id SERIAL NOT NULL UNIQUE,
	sell_id SERIAL NOT NULL UNIQUE
);
--pk
ALTER TABLE IF EXISTS client
ADD CONSTRAINT pk_client PRIMARY KEY (id);
ALTER TABLE IF EXISTS worker
    ADD CONSTRAINT pk_worker PRIMARY KEY (id,person_dni);

ALTER TABLE IF EXISTS client_delivery
ADD CONSTRAINT pk_client_delivery PRIMARY KEY (id);
	
ALTER TABLE IF EXISTS delivery_man
    ADD CONSTRAINT pk_delivery_man PRIMARY KEY (worker_id);
	
ALTER TABLE IF EXISTS shop_worker
    ADD CONSTRAINT pk_shop_worker PRIMARY KEY (worker_id);
	
ALTER TABLE IF EXISTS manager
    ADD CONSTRAINT pk_manager PRIMARY KEY (worker_id);
	
ALTER TABLE IF EXISTS in_charge
    ADD CONSTRAINT pk_in_charge PRIMARY KEY (shop_address,manager_id);
	
ALTER TABLE IF EXISTS shift
    ADD CONSTRAINT pk_shift PRIMARY KEY (worker_id,week_day);
	
ALTER TABLE IF EXISTS vehicle
    ADD CONSTRAINT pk_vehicle PRIMARY KEY (plate);
	
ALTER TABLE IF EXISTS shop
    ADD CONSTRAINT pk_shop PRIMARY KEY (address);
ALTER TABLE IF EXISTS has_promotion
    ADD PRIMARY KEY (promotion_id, product_code);
ALTER TABLE IF EXISTS isin
	ADD PRIMARY KEY (product_code, product_list_date);
ALTER TABLE IF EXISTS products_sell
	ADD PRIMARY KEY (local_direction, product_code);	
ALTER TABLE IF EXISTS person_detail
	ADD PRIMARY KEY (dni);	
ALTER TABLE local_sell ADD CONSTRAINT pk_venta_local PRIMARY KEY (id);

ALTER TABLE companies ADD CONSTRAINT pk_empresa PRIMARY KEY (ruc);

ALTER TABLE provisions ADD CONSTRAINT pk_pedido PRIMARY KEY (id);
ALTER TABLE IF EXISTS products ADD PRIMARY KEY (code);
ALTER TABLE IF EXISTS products_list ADD PRIMARY KEY (date);
ALTER TABLE IF EXISTS promotions ADD PRIMARY KEY (id);
--restricciones
ALTER TABLE IF EXISTS worker
    ADD UNIQUE (id);

ALTER TABLE IF EXISTS client_company
    ADD UNIQUE (ruc);

ALTER TABLE IF EXISTS provider_company
    ADD UNIQUE (ruc);

ALTER TABLE IF EXISTS delivery_sell
     ADD CHECK ( total > 0::MONEY );

ALTER TABLE IF EXISTS local_sell
     ADD CHECK ( total_price > 0::MONEY );

ALTER TABLE worker ADD CONSTRAINT trabajador_salario CHECK (salary > 0);

ALTER TABLE shift ADD CONSTRAINT llegada_salida CHECK (departure_time > arrival_time);

ALTER TABLE sell_unit_local ADD CONSTRAINT subtotal_local CHECK (subtotal > 0::MONEY);

ALTER TABLE sell_unit_local ADD CONSTRAINT monto_local CHECK (amount > 0);

ALTER TABLE sell_unit_delivery ADD CONSTRAINT subtotal_delivery CHECK (subtotal > 0::MONEY);

ALTER TABLE sell_unit_delivery ADD CONSTRAINT monto_delivery CHECK (amount > 0);

ALTER TABLE provisions ADD CONSTRAINT precio_total CHECK (total_price > 0::MONEY);

ALTER TABLE products_sell ADD CONSTRAINT stock CHECK (stock >= 0);

ALTER TABLE products ADD CONSTRAINT precio CHECK (price > 0::MONEY);
ALTER TABLE IF EXISTS proyecto_1k.delivery_sell
    ADD UNIQUE (id);

--fk
ALTER TABLE IF EXISTS worker
ADD CONSTRAINT fk_worker_person FOREIGN KEY (person_dni)
REFERENCES person_detail (dni);

ALTER TABLE IF EXISTS delivery_man
ADD CONSTRAINT fk_delivery_man_worker FOREIGN KEY (worker_id)
REFERENCES worker (id);

ALTER TABLE IF EXISTS delivery_man
ADD CONSTRAINT fk_delivery_man_vehicle FOREIGN KEY (vehicle_plate)
REFERENCES vehicle (plate);

ALTER TABLE IF EXISTS shop_worker
ADD CONSTRAINT fk_shop_worker_worker FOREIGN KEY (worker_id)
REFERENCES worker (id);

ALTER TABLE IF EXISTS shop_worker
ADD CONSTRAINT fk_shop_worker_shop FOREIGN KEY (shop_address)
REFERENCES shop (address);

ALTER TABLE IF EXISTS manager
ADD CONSTRAINT fk_manager_worker FOREIGN KEY (worker_id)
REFERENCES worker (id);

ALTER TABLE IF EXISTS in_charge
ADD CONSTRAINT fk_in_charge_shop FOREIGN KEY (shop_address)
REFERENCES shop (address);

ALTER TABLE IF EXISTS in_charge
ADD CONSTRAINT fk_in_charge_manager FOREIGN KEY (manager_id)
REFERENCES manager (worker_id);

ALTER TABLE IF EXISTS shift
ADD CONSTRAINT fk_shift_worker FOREIGN KEY (worker_id)
REFERENCES worker (id);

ALTER TABLE IF EXISTS vehicle
ADD CONSTRAINT fk_vehicle_shop FOREIGN KEY (shop_address)
REFERENCES shop (address);

ALTER TABLE local_sell ADD CONSTRAINT fk_venta_local FOREIGN KEY (address) REFERENCES shop (address);

ALTER TABLE company_local_buy ADD CONSTRAINT pk_empresa_compra_local FOREIGN KEY (ruc) REFERENCES client_company(ruc);

ALTER TABLE company_local_buy ADD CONSTRAINT fk_empresa_compra_local FOREIGN KEY (id) REFERENCES local_sell(id);

ALTER TABLE company_delivery_sell ADD CONSTRAINT fk_empresa_compra_local FOREIGN KEY (ruc) REFERENCES client_company(ruc);

ALTER TABLE company_delivery_sell ADD CONSTRAINT fk_empresa_compra_local1 FOREIGN KEY (id) REFERENCES local_sell(id);

ALTER TABLE provider_company ADD CONSTRAINT fk_empresa_proveedora FOREIGN KEY (ruc) REFERENCES companies(ruc);

ALTER TABLE provisions ADD CONSTRAINT fk_pedido FOREIGN KEY (address) REFERENCES shop (address);

ALTER TABLE IF EXISTS isin ADD CONSTRAINT fk_product_list_date FOREIGN KEY (product_list_date) REFERENCES products_list (date);

ALTER TABLE IF EXISTS isin ADD CONSTRAINT fk_product_code FOREIGN KEY (product_code) REFERENCES products (code);

ALTER TABLE IF EXISTS products_sell ADD CONSTRAINT prod1ucts_sell1 FOREIGN KEY (product_code) REFERENCES products (code);

ALTER TABLE IF EXISTS products_sell ADD CONSTRAINT prod1ucts_sell2 FOREIGN KEY (local_direction) REFERENCES shop (address);

ALTER TABLE IF EXISTS has_promotion ADD CONSTRAINT has_promotion1 FOREIGN KEY (product_code) REFERENCES products (code);

ALTER TABLE IF EXISTS has_promotion ADD CONSTRAINT has_promotion2 FOREIGN KEY (promotion_id) REFERENCES promotions (id);
ALTER TABLE IF EXISTS client_store
ADD CONSTRAINT fk_client_store_client FOREIGN KEY (id)
REFERENCES client (id);
ALTER TABLE customer_detail ADD CONSTRAINT fk_detalle_cliente FOREIGN KEY (dni) REFERENCES person_detail(dni);
ALTER TABLE customer_detail ADD CONSTRAINT fk_detalle_cliente FOREIGN KEY (id) REFERENCES client(id);

CREATE TABLE IF NOT EXISTS employee_detail(
    dni VARCHAR (8),
    id INTEGER
);
ALTER TABLE employee_detail ADD CONSTRAINT fk_detalle_empleado FOREIGN KEY (dni) REFERENCES person_detail(dni);
ALTER TABLE employee_detail ADD CONSTRAINT fk_detalle_empleado FOREIGN KEY (id) REFERENCES employee(id);


ALTER TABLE client ADD CONSTRAINT pk_cliente PRIMARY KEY (id);

ALTER TABLE client_store ADD CONSTRAINT fk_cliente_tienda FOREIGN KEY (id) REFERENCES client(id);

ALTER TABLE purchase_local ADD CONSTRAINT pk_compra_local FOREIGN KEY (v_id) REFERENCES local_sell(id);
ALTER TABLE purchase_local ADD CONSTRAINT pk_compra_local1 FOREIGN KEY (c_id) REFERENCES client_store(id);

ALTER TABLE purchase_delivery ADD CONSTRAINT fk_compra_delivery FOREIGN KEY (v_id) REFERENCES delivery_sell(id);
ALTER TABLE purchase_delivery ADD CONSTRAINT fk_compra_delivery1 FOREIGN KEY (c_id) REFERENCES client_delivery(id);

ALTER TABLE client_delivery ADD CONSTRAINT fk_cliente_delivery FOREIGN KEY (id) REFERENCES client(id);
ALTER TABLE IF EXISTS customer_detail
    ADD PRIMARY KEY (dni, id);
ALTER TABLE IF EXISTS customer_detail
    ADD FOREIGN KEY (dni)
    REFERENCES person_detail (dni);
ALTER TABLE IF EXISTS customer_detail
    ADD FOREIGN KEY (id)
    REFERENCES client (id);
	
ALTER TABLE IF EXISTS employee_detail
    ADD FOREIGN KEY (dni)
    REFERENCES person_detail (dni);

ALTER TABLE IF EXISTS employee_detail
    ADD FOREIGN KEY (id)
    REFERENCES worker (id);
